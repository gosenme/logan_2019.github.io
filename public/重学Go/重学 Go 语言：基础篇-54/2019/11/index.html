<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="4-17 字典设计模式17 Not-Addressable设计17 nil map17 nil vs empty17 ok_idiom设计4-17 字典设计模式17 Not-Addressable设计type User struct {    name string    age  int}func main() {    m := map[int]User{        1: {“user1”">
<meta property="og:type" content="article">
<meta property="og:title" content="重学 Go 语言：基础篇-54">
<meta property="og:url" content="http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/index.html">
<meta property="og:site_name" content="OYJX">
<meta property="og:description" content="4-17 字典设计模式17 Not-Addressable设计17 nil map17 nil vs empty17 ok_idiom设计4-17 字典设计模式17 Not-Addressable设计type User struct {    name string    age  int}func main() {    m := map[int]User{        1: {“user1”">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-11-30T10:53:51.203Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="重学 Go 语言：基础篇-54">
<meta name="twitter:description" content="4-17 字典设计模式17 Not-Addressable设计17 nil map17 nil vs empty17 ok_idiom设计4-17 字典设计模式17 Not-Addressable设计type User struct {    name string    age  int}func main() {    m := map[int]User{        1: {“user1”">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>重学 Go 语言：基础篇-54</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/重学Go/重学 Go 语言：基础篇-5518 预分配字典空间/2019/11/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/重学Go/重学 Go 语言：基础篇-53/2019/11/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&text=重学 Go 语言：基础篇-54"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&is_video=false&description=重学 Go 语言：基础篇-54"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=重学 Go 语言：基础篇-54&body=Check out this article: http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&name=重学 Go 语言：基础篇-54&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#417"><span class="toc-number">2.</span> <span class="toc-text">4-17 字典设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#17notaddressable"><span class="toc-number">2.1.</span> <span class="toc-text">17 Not-Addressable设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17nilmap"><span class="toc-number">2.2.</span> <span class="toc-text">17 nil map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17nilvsempty"><span class="toc-number">2.3.</span> <span class="toc-text">17 nil vs empty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17ok_idiom"><span class="toc-number">2.4.</span> <span class="toc-text">17 ok_idiom设计</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        重学 Go 语言：基础篇-54
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">OYJX</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-11-30T10:53:51.203Z" itemprop="datePublished">2019-11-30</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <article id="topicContainer" class="column_content"><h2 class="topic_title"></h2><div><p><div class="toc"><br><ul><br><li><ul><br><li><a href="#417">4-17 字典设计模式</a><ul><br><li><a href="#17notaddressable">17 Not-Addressable设计</a></li><br><li><a href="#17nilmap">17 nil map</a></li><br><li><a href="#17nilvsempty">17 nil vs empty</a></li><br><li><a href="#17ok_idiom">17 ok_idiom设计</a></li><br></ul><br></li><br></ul><br></li><br></ul><br></div><br></p><br><h2 id="417">4-17 字典设计模式</h2><br><h3 id="17notaddressable">17 Not-Addressable设计</h3><br><pre><code class="go language-go">type User struct {<br>    name string<br>    age  int<br>}<br><br>func main() {<br>    m := map[int]User{<br>        1: {“user1”, 20},<br>        2: {“user2”, 22},<br>    }<br>    m[3] = User{“user3”, 22} //赋值操作会翻译成具体的函数调用<br>    //可读<br>    println(m[1].name)<br><br>    m[1].age++ // 通过当前指针操作 cannot assign to struct field m[1].age in map<br>    //不可写 cannot assign to struct field m[1].name in map<br>    //m[1]返回的是复制品<br>    //m[1].name = “aaa”<br>    //m[1].age++<br><br>    u := m[1] //赋值给变量<br>    u.age++  //修改<br>    m[1] = u //赋值操作写回去<br><br>    m1 := make(map[int]<em>User)<br>    m1[1] = &amp;User{“tom”, 32}<br>    m1[1].name = “aaa”<br>    m1[1].age++<br>}<br></em></code></pre><br><blockquote><br>  <p>哈希表结构，鉴于扩容和数据迁移需要，设计为不可寻址模式。</p><br></blockquote><br><p>设计成不可寻址是因为内部的存储位置未必是固定的。插入数据空间不够的话就需要进行扩容，扩容要重新哈希，key可能被重新哈希另外的桶里。另外迁移的过程不是一次性是分批完成，如果取key或者Value的地址操作过程中可能发生扩容被迁移，对这个指针操作访问内存不安全。所以设计不可寻址，通过函数赋值是哈希算法内部算法，而通过指针直接操作内存。Go这种设计在很多语言里也有这样的限制。</p><br><p>它不允许这样操作的理由是什么？字典把keyvalue保存在内部，当返回value的时候有两种返回方式，第一种返回它的地址，可以直接用地址修改，第二种是整个value的复制品。返回地址比较危险，返回去赋值时候，不能保证是原子操作，有可能这个地址由于某种原因重新Hash为新地址了，在返回原来的地址上修改就破坏了内存安全模型，也就是跟它的内存安全模型可能有冲突。第二种返回的是复制品，修改的是复制品，修改的复制品没有任何意义，因为不持有这个复制品，我们管这东西叫临时变量，临时变量的意思就是没有任何东西引用它。</p><br><p>解决方法：</p><br><p>第一种方式，把复制品拷贝过去，然后对复制品进行修改，修改完把整个复制品拷贝到字典里面去。</p><br><p>第二种方式，字典的value使用指针，返回的复制品实际上是堆上的指针，指针指向堆上某个对象，通过指针修改对象有引用关系自然合法的。</p><br><p>同样的<code>m[key]++</code>和<code>m[key]+=</code>也遵循这样的设计。官方issues：3117</p><br><p>把Value读出来赋值给变量，修改变量以后把变量写回去，写回去不是通过指针操作而是调用哈希内部函数，它通过key重新找到处于哪个桶进行赋值。赋值语句被翻译成哈希内部函数，这个函数有哈希算法，找到对应的桶。还有一种方式value存储指针，获得指针不再是哈希内部的值而是目标对象，通过指针修改目标对象和字典没关系。通过指针操作对象属于语法糖。</p><br><p>很多语言都会有这样的事情，有些数据结构内部的存储不是固定的，甚至C#、Java不允许使用指针，因为对象在内存中存储位置也不是固定的，垃圾回收会压缩空间。所以对于内存安全访问模型我们把对象分成两种，一种是可寻址的一种不可寻址的，不可寻址的情况下，我们应该避免直接操作内部内存，因为它的存储位置是非固定的。</p><br><h3 id="17nilmap">17 nil map</h3><br><pre><code class="go language-go">func main() {<br>    var m map[int]int<br>    println(m[1]) // 0<br>    m[1] = 100    // panic: assignment to entry in nil map<br><br>    v, ok := m[100]<br>    fmt.Println(v, ok)<br>}<br></code></pre><br><blockquote><br>  <p>nil map可读不可写。</p><br></blockquote><br><p>空字典其实和字典相关的函数实现有关系。字典<code>m</code>理论不能用，本质上是一个指针，创建字典返回的是头部指针。比较奇怪的是，可以读任何一个key返回默认值零值，因为没有底层初始化结构不能写。</p><br><p>读操作只是和函数实现有关系，如果key没有或者空返回零值。</p><br><p>Go语言有两大模型，一个是返回值error模型，一个是OK模型。零值可能存储的就是零，可能是默认值，我们需要使用OK模型来判断。</p><br><h3 id="17nilvsempty">17 nil vs empty</h3><br><pre><code class="go language-go">func main() {<br>    var n map[int]int           // nil<br>    m := map[int]int{}          // empty<br>    println(n == nil, m == nil) // true, false<br>    println(len(n), len(m))     // 0, 0<br>}<br></code></pre><br><pre><code>(gdb) info locals<br>m = map[int]int<br>n = map[int]int&lt;error reading variable: Cannot access memory at address 0x9&gt;<br>(gdb) x/xg &amp;m<br>0xc00002e748: 0x000000c00002e758<br>(gdb) x/xg &amp;n<br>0xc00002e740: 0x0000000000000000<br></code></pre><br><p><code>n</code>是一个指针，8字节，实际上没有指向任何地方。<code>m</code>是make或者初始化语句，构建底层结构只不过在没有存数据数据而已。</p><br><h3 id="17ok_idiom">17 ok_idiom设计</h3><br><p>Go语言字典有个设计上的缺陷。</p><br><pre><code class="go language-go">var m map[int]int<br>// m := new(map[int]int)<br><br>// m[1] =100 //写操作失败<br>v, ok := m[1] //居然能读<br>println(v, ok)<br></code></pre><br><p>这属于Go设计上的不严谨。能读但是写不行。空指针不能工作的居然可以从里面读，因为既然不能写，又没有只读属性，那应该从设计角度保证行为是一致的，作为可读写的字典在没有合法分配内存的情况下写操作肯定失败，读操作成功就莫名其妙。所以不能通过上面判断m是否合法。这属于设计上的缺陷，行为没有保证一致性。</p><br><p>关于ok模式设计还是有讲究的。</p><br><pre><code class="go language-go">func main() {<br>    var s string = “abc”<br><br>    m := map[string]int{<br>        s: 0x100,<br>    }<br><br>    b := []byte(s)<br>    v, ok := m[string(b)]<br><br>    println(v, ok)<br>}<br></code></pre><br><p>很多语言都有这样的一个做法用于判断m里面是否有个key。Go没有，Go的做法实际上通过ok模型完成的。因为<code>m[“a”]</code>返回0但是不知道a是否在字典里面。Go语言ok_idiom模型会返回两个值，v和ok，如果不存在v就是默认值，ok表示是否找到就是这个操作是否成功。</p><br><p>当设计一个接口的时候，返回一个默认值，默认值到底表达什么概念，能不能真的区分清楚，如果我们不关系存不存在就返回默认值没有问题，但是需要在默认值之外还能知道这个默认值到底是怎么得来的，是因为操作成功得来的还是因为操作失败得来的，默认值还有一种可能就是真实的值。所以在设计时可以返回两个值，默认值和什么原因。</p></div></article>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#417"><span class="toc-number">2.</span> <span class="toc-text">4-17 字典设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#17notaddressable"><span class="toc-number">2.1.</span> <span class="toc-text">17 Not-Addressable设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17nilmap"><span class="toc-number">2.2.</span> <span class="toc-text">17 nil map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17nilvsempty"><span class="toc-number">2.3.</span> <span class="toc-text">17 nil vs empty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17ok_idiom"><span class="toc-number">2.4.</span> <span class="toc-text">17 ok_idiom设计</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&text=重学 Go 语言：基础篇-54"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&is_video=false&description=重学 Go 语言：基础篇-54"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=重学 Go 语言：基础篇-54&body=Check out this article: http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&title=重学 Go 语言：基础篇-54"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://logan_2019.github.io/重学Go/重学 Go 语言：基础篇-54/2019/11/&name=重学 Go 语言：基础篇-54&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Logan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
